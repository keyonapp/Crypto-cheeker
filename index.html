<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coin Crypto Cheeker</title>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #fff;
      color: #000;
      transition: 0.3s;
    }
    body.dark {
      background-color: #121212;
      color: #fff;
    }

    .toggle-switch {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
    }
    .toggle-switch input {
      width: 40px;
      height: 20px;
      appearance: none;
      background: #ccc;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
    }
    .toggle-switch input:checked {
      background: #4caf50;
    }
    .toggle-switch input::before {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }
    .toggle-switch input:checked::before {
      left: 21px;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      padding: 1rem;
    }

    .page { display: none; }
    .page.active { display: block; }

    .coin-link {
      color: #007bff;
      text-decoration: underline;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }

    #tv-chart {
      width: 100%;
      height: 500px;
      margin-top: 1rem;
    }

    .navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      background-color: #1c1c1e;
      color: #aaa;
      padding: 0.5rem 0;
    }
    .navbar button {
      background: none;
      border: none;
      color: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      text-align: center;
    }
    .navbar button.active {
      color: #4cafef;
    }
    .navbar.hidden {
      display: none;
    }

    .news-item {
      background: #f5f5f5;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      padding: 1rem;
      transition: 0.3s;
    }
    body.dark .news-item {
      background: #1e1e1e;
      box-shadow: 0 2px 5px rgba(255,255,255,0.05);
    }
  </style>
</head>
<body>
  <div class="toggle-switch">
    <input type="checkbox" id="themeToggle" onchange="toggleMode()">
  </div>

  <!-- Halaman Market -->
  <div class="page active" id="page-market">
    <div class="container">
      <h1>Coin Crypto Cheeker</h1>
      <div id="table-container"></div>
      <div id="detail-container" style="display:none;">
        <button onclick="backToList()">â¬… Kembali</button>
        <h2 id="coin-name"></h2>
        <div id="tv-chart"></div>
        <div id="coin-info"></div>
      </div>
    </div>
  </div>

  <!-- Halaman Rekomendasi Pump -->
  <div class="page" id="page-news">
    <div class="container">
      <h1>Rekomendasi Coin Akan Pump ðŸš€</h1>
      <div id="news-container">Memuat...</div>
    </div>
  </div>

  <!-- Navigasi -->
  <div class="navbar" id="navbar">
    <button onclick="switchPage('market')" id="btn-market" class="active">ðŸ“ˆ<br>Pasar</button>
    <button onclick="switchPage('news')" id="btn-news">ðŸš€<br>Rekomendasi</button>
  </div>

  <script>
    let coinsData = [], currentSymbol = "", tvWidget = null;

    function toggleMode() {
      const dark = document.getElementById("themeToggle").checked;
      localStorage.setItem("theme_mode", dark ? "dark" : "light");
      document.body.classList.toggle("dark", dark);
      if (currentSymbol) setTimeout(() => renderTradingView(currentSymbol), 100);
    }

    function switchPage(page) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(`page-${page}`).classList.add("active");
      document.querySelectorAll(".navbar button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(`btn-${page}`).classList.add("active");
      document.getElementById("navbar").classList.remove("hidden");
      if (page === "news") fetchPumpRecommendations();
    }

    async function fetchCoins() {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&price_change_percentage=1h");
        coinsData = await res.json();
        renderTable();
      } catch (e) {
        console.error("Gagal memuat coin:", e);
      }
    }

    function renderTable() {
      const container = document.getElementById("table-container");
      container.innerHTML = `<table><thead><tr><th>#</th><th>Coin</th><th>Harga</th><th>24j (%)</th></tr></thead><tbody>${
        coinsData.map(c => `<tr>
          <td>${c.market_cap_rank}</td>
          <td><span class="coin-link" onclick="showDetail('${c.id}')">${c.name} (${c.symbol.toUpperCase()})</span></td>
          <td>$${c.current_price.toLocaleString()}</td>
          <td style="color:${c.price_change_percentage_24h>=0?'limegreen':'red'}">${c.price_change_percentage_24h?.toFixed(2)}%</td>
        </tr>`).join("")
      }</tbody></table>`;
    }

    async function showDetail(id) {
      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/coins/${id}`);
        const data = await res.json();
        currentSymbol = data.symbol.toUpperCase();
        document.getElementById("coin-name").textContent = `${data.name} (${currentSymbol})`;
        document.getElementById("coin-info").innerHTML = `
          <p><strong>Harga:</strong> $${data.market_data.current_price.usd.toLocaleString()}</p>
          <p><strong>Market Cap:</strong> $${data.market_data.market_cap.usd.toLocaleString()}</p>
          <p><strong>Volume:</strong> $${data.market_data.total_volume.usd.toLocaleString()}</p>
          <p><strong>Deskripsi:</strong><br>${data.description.id || data.description.en || "Tidak tersedia"}</p>
        `;
        document.getElementById("detail-container").style.display = "block";
        document.getElementById("table-container").style.display = "none";
        document.getElementById("navbar").classList.add("hidden");

        setTimeout(() => {
          if (document.getElementById("tv-chart")) {
            renderTradingView(currentSymbol);
          }
        }, 400);
      } catch (e) {
        alert("Gagal memuat detail coin.");
      }
    }

    function renderTradingView(symbol) {
      document.getElementById("tv-chart").innerHTML = "";
      const theme = document.body.classList.contains("dark") ? "dark" : "light";
      try {
        tvWidget = new TradingView.widget({
          container_id: "tv-chart",
          symbol: `BINANCE:${symbol}USDT`,
          interval: "5",
          timezone: "Etc/UTC",
          theme: theme,
          style: "1",
          locale: "id",
          toolbar_bg: "#f1f3f6",
          enable_publishing: false,
          hide_side_toolbar: false,
          allow_symbol_change: false,
          autosize: true
        });
      } catch (e) {
        console.error("TradingView error:", e);
      }
    }

    function backToList() {
      document.getElementById("detail-container").style.display = "none";
      document.getElementById("table-container").style.display = "block";
      document.getElementById("navbar").classList.remove("hidden");
    }

    function fetchPumpRecommendations() {
      const LAST_FETCH_KEY = 'pump_last_fetch';
      const CACHE_KEY = 'pump_cache';
      const HOURS = 5;
      const now = Date.now();
      const last = localStorage.getItem(LAST_FETCH_KEY);

      if (last && now - Number(last) < HOURS * 60 * 60 * 1000) {
        const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
        if (cached) return renderPumpList(cached);
      }

      const sorted = [...coinsData]
        .filter(c => typeof c.price_change_percentage_1h_in_currency === "number")
        .sort((a, b) => b.price_change_percentage_1h_in_currency - a.price_change_percentage_1h_in_currency)
        .slice(0, 10);

      localStorage.setItem(LAST_FETCH_KEY, now);
      localStorage.setItem(CACHE_KEY, JSON.stringify(sorted));
      renderPumpList(sorted);
    }

    function renderPumpList(list) {
      const container = document.getElementById("news-container");
      container.innerHTML = list.map(c => `
        <div class="news-item">
          <h3>${c.name} (${c.symbol.toUpperCase()})</h3>
          <p><strong>Kenaikan 1 jam:</strong> ${c.price_change_percentage_1h_in_currency?.toFixed(2)}%</p>
          <p><strong>Harga:</strong> $${c.current_price}</p>
        </div>
      `).join("");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("theme_mode");
      if (savedTheme === "dark") {
        document.body.classList.add("dark");
        document.getElementById("themeToggle").checked = true;
      }
    });

    fetchCoins();
    setInterval(fetchCoins, 5000);
  </script>
</body>
</html>
